<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rejig Commission Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .logo { height: 50px; }
        .header-text { flex: 1; }
        h1 { font-size: 28px; margin-bottom: 5px; color: #1a1a1a; }
        .subtitle { color: #666; font-size: 14px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 6px; border-left: 4px solid #05c68e; }
        .card.warning { border-left-color: #daba21; }
        .card-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .card-value { font-size: 24px; font-weight: 600; color: #1a1a1a; }
        .add-deal-form { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 12px; font-weight: 500; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .add-btn { background: #6537ca; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .section-toggle { background: none; border: none; color: #6537ca; font-size: 14px; cursor: pointer; padding: 0; margin-bottom: 15px; text-decoration: underline; }
        .sync-status { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #05c68e; }
        .sync-status.error { border-left-color: #f15d55; }
        .sync-status.loading { border-left-color: #daba21; }
        .sync-info { font-size: 13px; color: #666; }
        .refresh-btn { background: #6537ca; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .refresh-btn:hover { background: #5429ab; }
        .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }
        .logo-text { font-size: 32px; font-weight: 700; color: #05c68e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .current-month-card { background: linear-gradient(135deg, #6537ca 0%, #5429ab 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }
        .current-month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .current-month-title { font-size: 24px; font-weight: 600; }
        .selling-days-input { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 4px; width: 120px; font-size: 14px; }
        .selling-days-input::placeholder { color: rgba(255,255,255,0.7); }
        .attainment-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .metric { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px; }
        .metric-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
        .metric-value { font-size: 28px; font-weight: 700; }
        .metric-sub { font-size: 13px; opacity: 0.8; margin-top: 5px; }
        .progress-bar-container { background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 15px; }
        .progress-bar { background: #05c68e; height: 100%; transition: width 0.3s; }
        .progress-bar.behind { background: #f15d55; }
        .progress-bar.on-track { background: #05c68e; }
        .progress-bar.ahead { background: #daba21; }
        .deals-section { margin-bottom: 30px; }
        .deal-item { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 10px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 120px; gap: 15px; align-items: center; }
        .deal-item.churned { opacity: 0.5; background: #ffeaea; }
        .deal-name { font-weight: 500; }
        .deal-meta { font-size: 12px; color: #666; }
        .churn-input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .unchurn-btn { background: #05c68e; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .monthly-breakdown { margin-top: 30px; }
        .year-section { margin-bottom: 20px; }
        .year-header { background: #6537ca; color: white; padding: 15px 20px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .year-header:hover { background: #5429ab; }
        .year-title { font-size: 20px; font-weight: 600; }
        .year-commission { font-size: 18px; }
        .expand-icon { transition: transform 0.2s; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .month-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 20px; margin: 10px 0; cursor: pointer; }
        .month-card:hover { background: #f8f9fa; }
        .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .month-title { font-size: 16px; font-weight: 500; color: #1a1a1a; }
        .month-commission { font-size: 18px; font-weight: 600; color: #05c68e; }
        .month-commission.zero { color: #999; }
        .month-details { font-size: 13px; color: #666; line-height: 1.6; }
        .revenue-bar { height: 8px; background: #e0e0e0; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .revenue-fill { height: 100%; background: #05c68e; transition: width 0.3s; }
        .revenue-fill.under-threshold { background: #f15d55; }
        .deal-breakdown { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .deal-breakdown-item { padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; font-size: 13px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const MONTHLY_THRESHOLD = 6666.67;
        const COMMISSION_RATE = 0.20;

        // IMPORTANT: After deploying your Google Apps Script, paste the Web App URL here
        // It will look like: https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
        const GOOGLE_APPS_SCRIPT_URL = 'PASTE_YOUR_APPS_SCRIPT_URL_HERE';

        // Fallback deals in case the Google Apps Script fails or isn't configured yet
        const fallbackDeals = [
            {id: 1, name: "Brian Shisler", close: "2025-07-01", subscription: 100, setup: 250, cycle: "monthly", churnDate: null},
            {id: 2, name: "Kelly Solberg", close: "2025-07-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 3, name: "Scott Armstrong", close: "2025-07-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 4, name: "Aline Roy", close: "2025-07-01", subscription: 150, setup: 250, cycle: "monthly", churnDate: null},
            {id: 5, name: "Julie Brown", close: "2025-07-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 6, name: "Grady Rohn", close: "2025-07-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 7, name: "Mary Beth Grasso", close: "2025-07-01", subscription: 900, setup: 0, cycle: "six-month", churnDate: null},
            {id: 8, name: "Avery Meizner", close: "2025-07-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 9, name: "Aaron Rose", close: "2025-08-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 10, name: "Scott Gaetner", close: "2025-08-01", subscription: 100, setup: 250, cycle: "monthly", churnDate: null},
            {id: 11, name: "Willie Adolph", close: "2025-08-01", subscription: 600, setup: 0, cycle: "six-month", churnDate: null},
            {id: 12, name: "Kelly Calkins Roberts", close: "2025-08-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 13, name: "Barbara Wiedman", close: "2025-08-01", subscription: 900, setup: 0, cycle: "six-month", churnDate: null},
            {id: 14, name: "Sonia Silva", close: "2025-08-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 15, name: "Roz Rogers", close: "2025-08-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 16, name: "Jim Crotwell", close: "2025-08-01", subscription: 600, setup: 0, cycle: "six-month", churnDate: null},
            {id: 17, name: "John Major", close: "2025-08-01", subscription: 100, setup: 250, cycle: "monthly", churnDate: null},
            {id: 18, name: "Phillip Vaughan", close: "2025-08-01", subscription: 100, setup: 250, cycle: "monthly", churnDate: null},
            {id: 19, name: "Erin Stevens", close: "2025-09-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 20, name: "Joseph Spurlock", close: "2025-09-01", subscription: 600, setup: 0, cycle: "six-month", churnDate: null},
            {id: 21, name: "Davian Akers", close: "2025-09-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 22, name: "Nancy Quiroz", close: "2025-09-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 23, name: "Sarah Clear", close: "2025-09-01", subscription: 600, setup: 0, cycle: "six-month", churnDate: null},
            {id: 24, name: "Jonathan Meek", close: "2025-10-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 25, name: "CJ Singh", close: "2025-10-01", subscription: 600, setup: 0, cycle: "six-month", churnDate: null},
            {id: 26, name: "Ann Kraase", close: "2025-10-01", subscription: 1800, setup: 0, cycle: "yearly", churnDate: null},
            {id: 27, name: "Laura Miller Edwards", close: "2025-10-01", subscription: 120, setup: 0, cycle: "monthly", churnDate: null},
            {id: 28, name: "Cheryl Glynn", close: "2025-10-01", subscription: 80, setup: 0, cycle: "monthly", churnDate: null},
            {id: 29, name: "Robert Zahn", close: "2025-10-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 30, name: "Emmett Carr", close: "2025-10-01", subscription: 120, setup: 0, cycle: "monthly", churnDate: null},
            {id: 31, name: "Lisa Treu", close: "2025-10-01", subscription: 1200, setup: 0, cycle: "yearly", churnDate: null},
            {id: 32, name: "Patrick Higgins", close: "2025-10-01", subscription: 900, setup: 100, cycle: "six-month", churnDate: null},
            {id: 33, name: "Helena Gentila", close: "2025-11-01", subscription: 900, setup: 100, cycle: "six-month", churnDate: null},
            {id: 34, name: "Cyndee Haydon", close: "2025-11-01", subscription: 900, setup: 0, cycle: "six-month", churnDate: null},
            {id: 35, name: "Seb Ebrahimi", close: "2025-11-01", subscription: 900, setup: 0, cycle: "six-month", churnDate: null},
            {id: 36, name: "Jason Gracey", close: "2025-11-01", subscription: 1800, setup: 0, cycle: "yearly", churnDate: null},
            {id: 37, name: "Tass Fry", close: "2025-11-01", subscription: 600, setup: 100, cycle: "six-month", churnDate: null},
            {id: 38, name: "Lisa Forss", close: "2025-11-01", subscription: 6480, setup: 0, cycle: "two-year", churnDate: null}
        ];
        
        const CommissionTracker = () => {
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastSync, setLastSync] = useState(null);
            const [expandedYears, setExpandedYears] = useState({'2025': true});
            const [expandedMonths, setExpandedMonths] = useState({});
            const [showDeals, setShowDeals] = useState(false);
            const [sellingDays, setSellingDays] = useState(() => {
                const saved = localStorage.getItem('currentMonthSellingDays');
                return saved ? JSON.parse(saved) : {};
            });
            const [newDeal, setNewDeal] = useState({
                name: '',
                close: new Date().toISOString().split('T')[0],
                subscription: '',
                setup: '',
                cycle: 'six-month'
            });
            
            // Fetch deals from Google Sheets on component mount
            useEffect(() => {
                fetchDealsFromSheet();
            }, []);

            // Save deals to localStorage when they change
            useEffect(() => {
                if (deals.length > 0) {
                    localStorage.setItem('commissionDeals', JSON.stringify(deals));
                }
            }, [deals]);

            // Save selling days to localStorage when they change
            useEffect(() => {
                localStorage.setItem('currentMonthSellingDays', JSON.stringify(sellingDays));
            }, [sellingDays]);

            const fetchDealsFromSheet = async () => {
                setLoading(true);
                setError(null);

                try {
                    // Check if Apps Script URL is configured
                    if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL === 'PASTE_YOUR_APPS_SCRIPT_URL_HERE') {
                        console.log('Apps Script URL not configured, using fallback data');
                        const saved = localStorage.getItem('commissionDeals');
                        setDeals(saved ? JSON.parse(saved) : fallbackDeals);
                        setLastSync(new Date().toISOString());
                        setLoading(false);
                        return;
                    }

                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                    const result = await response.json();

                    if (result.success && result.data) {
                        setDeals(result.data);
                        setLastSync(result.timestamp || new Date().toISOString());
                        console.log(`Loaded ${result.data.length} deals from Google Sheets`);
                    } else {
                        throw new Error(result.error || 'Failed to fetch deals');
                    }
                } catch (err) {
                    console.error('Error fetching from Google Sheets:', err);
                    setError(err.message);

                    // Fall back to localStorage or fallback deals
                    const saved = localStorage.getItem('commissionDeals');
                    setDeals(saved ? JSON.parse(saved) : fallbackDeals);
                } finally {
                    setLoading(false);
                }
            };
            
            const addNewDeal = () => {
                if (!newDeal.name || !newDeal.subscription) return;
                
                const deal = {
                    id: Math.max(...deals.map(d => d.id), 0) + 1,
                    name: newDeal.name,
                    close: newDeal.close,
                    subscription: parseFloat(newDeal.subscription),
                    setup: parseFloat(newDeal.setup) || 0,
                    cycle: newDeal.cycle,
                    churnDate: null
                };
                
                setDeals([...deals, deal]);
                setNewDeal({
                    name: '',
                    close: new Date().toISOString().split('T')[0],
                    subscription: '',
                    setup: '',
                    cycle: 'six-month'
                });
            };
            
            const setChurnDate = (dealId, date) => {
                setDeals(deals.map(d => d.id === dealId ? {...d, churnDate: date} : d));
            };
            
            const removeChurn = (dealId) => {
                setDeals(deals.map(d => d.id === dealId ? {...d, churnDate: null} : d));
            };
            
            const monthlyBreakdown = useMemo(() => {
                const breakdown = {};
                const endDate = new Date('2027-12-31');
                
                deals.forEach(deal => {
                    const closeDate = new Date(deal.close);
                    const churnDate = deal.churnDate ? new Date(deal.churnDate) : null;
                    let currentDate = new Date(closeDate);
                    
                    let renewalMonths;
                    if (deal.cycle === "monthly") renewalMonths = 1;
                    else if (deal.cycle === "six-month") renewalMonths = 6;
                    else if (deal.cycle === "yearly") renewalMonths = 12;
                    else if (deal.cycle === "two-year") renewalMonths = 24;
                    
                    let isFirstPayment = true;
                    
                    while (currentDate <= endDate) {
                        if (churnDate && currentDate > churnDate) break;
                        
                        const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!breakdown[monthKey]) {
                            breakdown[monthKey] = { revenue: 0, deals: [] };
                        }
                        
                        const amount = isFirstPayment ? deal.setup + deal.subscription : deal.subscription;
                        breakdown[monthKey].revenue += amount;
                        breakdown[monthKey].deals.push({
                            name: deal.name,
                            amount: amount,
                            type: isFirstPayment ? 'new' : 'renewal'
                        });
                        
                        isFirstPayment = false;
                        currentDate.setMonth(currentDate.getMonth() + renewalMonths);
                    }
                });
                
                Object.keys(breakdown).forEach(month => {
                    const revenue = breakdown[month].revenue;
                    breakdown[month].commission = revenue > MONTHLY_THRESHOLD ? 
                        (revenue - MONTHLY_THRESHOLD) * COMMISSION_RATE : 0;
                    breakdown[month].overThreshold = revenue - MONTHLY_THRESHOLD;
                });
                
                return breakdown;
            }, [deals]);
            
            const yearlyBreakdown = useMemo(() => {
                const years = {};
                Object.entries(monthlyBreakdown).forEach(([monthKey, data]) => {
                    const year = monthKey.split('-')[0];
                    if (!years[year]) {
                        years[year] = { commission: 0, revenue: 0, months: {} };
                    }
                    years[year].commission += data.commission;
                    years[year].revenue += data.revenue;
                    years[year].months[monthKey] = data;
                });
                return years;
            }, [monthlyBreakdown]);
            
            const totalCommission = Object.values(yearlyBreakdown).reduce((sum, y) => sum + y.commission, 0);
            const activeDeals = deals.filter(d => !d.churnDate || new Date(d.churnDate) > new Date());

            // Calculate business days elapsed in current month (excluding weekends)
            const getBusinessDaysElapsed = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const today = now.getDate();

                let businessDays = 0;
                for (let day = 1; day <= today; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    // Skip weekends (0 = Sunday, 6 = Saturday)
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        businessDays++;
                    }
                }
                return businessDays;
            };

            // Current month attainment
            const currentMonthData = useMemo(() => {
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const currentMonth = monthlyBreakdown[currentMonthKey] || { revenue: 0, commission: 0, deals: [] };

                const businessDaysElapsed = getBusinessDaysElapsed();
                const totalSellingDays = sellingDays[currentMonthKey] || 20; // Default to 20 if not set

                const daysProgress = (businessDaysElapsed / totalSellingDays) * 100;
                const revenueProgress = (currentMonth.revenue / MONTHLY_THRESHOLD) * 100;
                const attainment = totalSellingDays > 0 ? (revenueProgress / daysProgress) * 100 : 0;

                const expectedRevenue = (MONTHLY_THRESHOLD / totalSellingDays) * businessDaysElapsed;
                const variance = currentMonth.revenue - expectedRevenue;

                return {
                    monthKey: currentMonthKey,
                    revenue: currentMonth.revenue,
                    commission: currentMonth.commission,
                    businessDaysElapsed,
                    totalSellingDays,
                    daysProgress,
                    revenueProgress,
                    attainment,
                    expectedRevenue,
                    variance,
                    deals: currentMonth.deals || []
                };
            }, [monthlyBreakdown, sellingDays]);

            const updateSellingDays = (monthKey, days) => {
                setSellingDays({...sellingDays, [monthKey]: parseInt(days) || 0});
            };
            
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };
            
            const formatMonth = (monthKey) => {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };
            
            const toggleYear = (year) => {
                setExpandedYears({...expandedYears, [year]: !expandedYears[year]});
            };
            
            const toggleMonth = (monthKey) => {
                setExpandedMonths({...expandedMonths, [monthKey]: !expandedMonths[monthKey]});
            };
            
            return (
                <div className="container">
                    <div className="header">
                        <div className="logo-text">rejig.ai</div>
                        <div className="header-text">
                            <h1>Commission Tracker</h1>
                            <p className="subtitle">Monthly threshold: {formatCurrency(MONTHLY_THRESHOLD)} | Commission rate: 20%</p>
                        </div>
                    </div>
                    

                    {lastSync && (
                        <div className={`sync-status ${loading ? 'loading' : error ? 'error' : ''}`}>
                            <div className="sync-info">
                                {loading ? (
                                    'Syncing with Google Sheets...' 
                                ) : error ? (
                                    `Sync error: ${error}. Using cached data.`
                                ) : (
                                    `Last synced: ${new Date(lastSync).toLocaleString()} • ${deals.length} deals loaded`
                                )}
                            </div>
                            <button
                                className="refresh-btn"
                                onClick={fetchDealsFromSheet}
                                disabled={loading}
                            >
                                {loading ? 'Syncing...' : 'Refresh from Sheet'}
                            </button>
                        </div>
                    )}

                    <div className="current-month-card">
                        <div className="current-month-header">
                            <div className="current-month-title">
                                {formatMonth(currentMonthData.monthKey)} - Attainment
                            </div>
                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                <label style={{fontSize: '14px', opacity: 0.9}}>Selling Days:</label>
                                <input
                                    type="number"
                                    className="selling-days-input"
                                    value={currentMonthData.totalSellingDays}
                                    onChange={(e) => updateSellingDays(currentMonthData.monthKey, e.target.value)}
                                    placeholder="20"
                                    min="1"
                                    max="31"
                                />
                            </div>
                        </div>

                        <div className="attainment-metrics">
                            <div className="metric">
                                <div className="metric-label">Current Revenue</div>
                                <div className="metric-value">{formatCurrency(currentMonthData.revenue)}</div>
                                <div className="metric-sub">
                                    {currentMonthData.revenue >= MONTHLY_THRESHOLD ?
                                        `+${formatCurrency(currentMonthData.revenue - MONTHLY_THRESHOLD)} over threshold` :
                                        `${formatCurrency(MONTHLY_THRESHOLD - currentMonthData.revenue)} to threshold`
                                    }
                                </div>
                            </div>

                            <div className="metric">
                                <div className="metric-label">Days Elapsed</div>
                                <div className="metric-value">
                                    {currentMonthData.businessDaysElapsed} / {currentMonthData.totalSellingDays}
                                </div>
                                <div className="metric-sub">
                                    {currentMonthData.daysProgress.toFixed(0)}% of month complete
                                </div>
                            </div>

                            <div className="metric">
                                <div className="metric-label">Attainment</div>
                                <div className="metric-value">
                                    {currentMonthData.attainment.toFixed(0)}%
                                </div>
                                <div className="metric-sub">
                                    {currentMonthData.variance >= 0 ?
                                        `${formatCurrency(currentMonthData.variance)} ahead` :
                                        `${formatCurrency(Math.abs(currentMonthData.variance))} behind`
                                    }
                                </div>
                            </div>

                            <div className="metric">
                                <div className="metric-label">Commission (MTD)</div>
                                <div className="metric-value">{formatCurrency(currentMonthData.commission)}</div>
                                <div className="metric-sub">
                                    {currentMonthData.deals.length} deals closed
                                </div>
                            </div>
                        </div>

                        <div className="progress-bar-container">
                            <div
                                className={`progress-bar ${
                                    currentMonthData.attainment >= 100 ? 'ahead' :
                                    currentMonthData.attainment >= 90 ? 'on-track' : 'behind'
                                }`}
                                style={{width: `${Math.min(currentMonthData.revenueProgress, 100)}%`}}
                            />
                        </div>
                        <div style={{fontSize: '12px', marginTop: '10px', opacity: 0.9}}>
                            Progress: {currentMonthData.revenueProgress.toFixed(1)}% of threshold goal
                        </div>
                    </div>

                    <div className="summary-cards">
                        <div className="card">
                            <div className="card-label">Active Deals</div>
                            <div className="card-value">{activeDeals.length} / {deals.length}</div>
                        </div>
                        <div className="card">
                            <div className="card-label">Total Commission Earned</div>
                            <div className="card-value">{formatCurrency(totalCommission)}</div>
                        </div>
                        <div className="card warning">
                            <div className="card-label">Months Over Threshold</div>
                            <div className="card-value">
                                {Object.values(monthlyBreakdown).filter(m => m.commission > 0).length}
                            </div>
                        </div>
                    </div>
                    
                    <div className="add-deal-form">
                        <h2 style={{marginBottom: '15px', fontSize: '18px'}}>Add New Deal</h2>
                        <div className="form-row">
                            <div className="form-group">
                                <label>Customer Name</label>
                                <input 
                                    type="text" 
                                    value={newDeal.name}
                                    onChange={(e) => setNewDeal({...newDeal, name: e.target.value})}
                                    placeholder="John Smith"
                                />
                            </div>
                            <div className="form-group">
                                <label>Close Date</label>
                                <input 
                                    type="date" 
                                    value={newDeal.close}
                                    onChange={(e) => setNewDeal({...newDeal, close: e.target.value})}
                                />
                            </div>
                            <div className="form-group">
                                <label>Subscription Amount</label>
                                <input 
                                    type="number" 
                                    value={newDeal.subscription}
                                    onChange={(e) => setNewDeal({...newDeal, subscription: e.target.value})}
                                    placeholder="600"
                                />
                            </div>
                            <div className="form-group">
                                <label>Setup Fee</label>
                                <input 
                                    type="number" 
                                    value={newDeal.setup}
                                    onChange={(e) => setNewDeal({...newDeal, setup: e.target.value})}
                                    placeholder="100"
                                />
                            </div>
                            <div className="form-group">
                                <label>Billing Cycle</label>
                                <select 
                                    value={newDeal.cycle}
                                    onChange={(e) => setNewDeal({...newDeal, cycle: e.target.value})}
                                >
                                    <option value="monthly">Monthly</option>
                                    <option value="six-month">6 Months</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="two-year">2 Years</option>
                                </select>
                            </div>
                        </div>
                        <button className="add-btn" onClick={addNewDeal}>Add Deal</button>
                    </div>
                    
                    <div className="deals-section">
                        <button className="section-toggle" onClick={() => setShowDeals(!showDeals)}>
                            {showDeals ? 'Hide' : 'Show'} All Deals ({deals.length})
                        </button>
                        {showDeals && deals.map(deal => (
                            <div key={deal.id} className={`deal-item ${deal.churnDate ? 'churned' : ''}`}>
                                <div>
                                    <div className="deal-name">{deal.name}</div>
                                    <div className="deal-meta">
                                        Closed {new Date(deal.close).toLocaleDateString()} • {deal.cycle}
                                    </div>
                                </div>
                                <div>{formatCurrency(deal.subscription)} subscription</div>
                                <div>{formatCurrency(deal.setup)} setup</div>
                                <div>
                                    {deal.churnDate ? (
                                        <span style={{color: '#f15d55', fontSize: '13px'}}>
                                            Churned {new Date(deal.churnDate).toLocaleDateString()}
                                        </span>
                                    ) : (
                                        <span style={{color: '#05c68e', fontSize: '13px'}}>Active</span>
                                    )}
                                </div>
                                <div>
                                    {!deal.churnDate ? (
                                        <input 
                                            type="date" 
                                            className="churn-input"
                                            onChange={(e) => e.target.value && setChurnDate(deal.id, e.target.value)}
                                        />
                                    ) : (
                                        <button className="unchurn-btn" onClick={() => removeChurn(deal.id)}>
                                            Reactivate
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="monthly-breakdown">
                        <h2 style={{marginBottom: '20px', fontSize: '20px'}}>Commission Breakdown</h2>
                        {Object.keys(yearlyBreakdown).sort().reverse().map(year => (
                            <div key={year} className="year-section">
                                <div className="year-header" onClick={() => toggleYear(year)}>
                                    <div className="year-title">
                                        {year}
                                        <span className={`expand-icon ${expandedYears[year] ? 'expanded' : ''}`}> ▼</span>
                                    </div>
                                    <div className="year-commission">
                                        {formatCurrency(yearlyBreakdown[year].commission)} commission
                                    </div>
                                </div>
                                
                                {expandedYears[year] && Object.keys(yearlyBreakdown[year].months).sort().map(monthKey => {
                                    const data = yearlyBreakdown[year].months[monthKey];
                                    const percentOfThreshold = (data.revenue / MONTHLY_THRESHOLD) * 100;
                                    const isExpanded = expandedMonths[monthKey];
                                    
                                    return (
                                        <div key={monthKey} className="month-card">
                                            <div onClick={() => toggleMonth(monthKey)}>
                                                <div className="month-header">
                                                    <div className="month-title">
                                                        {formatMonth(monthKey)}
                                                        <span className={`expand-icon ${isExpanded ? 'expanded' : ''}`}> ▼</span>
                                                    </div>
                                                    <div className={`month-commission ${data.commission === 0 ? 'zero' : ''}`}>
                                                        {data.commission > 0 ? formatCurrency(data.commission) : 'No commission'}
                                                    </div>
                                                </div>
                                                
                                                <div className="revenue-bar">
                                                    <div 
                                                        className={`revenue-fill ${data.revenue <= MONTHLY_THRESHOLD ? 'under-threshold' : ''}`}
                                                        style={{width: `${Math.min(percentOfThreshold, 100)}%`}}
                                                    />
                                                </div>
                                                
                                                <div className="month-details">
                                                    Total Revenue: {formatCurrency(data.revenue)} 
                                                    {data.revenue > MONTHLY_THRESHOLD ? 
                                                        ` (${formatCurrency(data.overThreshold)} over threshold)` : 
                                                        ` (${formatCurrency(MONTHLY_THRESHOLD - data.revenue)} under threshold)`
                                                    }
                                                </div>
                                            </div>
                                            
                                            {isExpanded && (
                                                <div className="deal-breakdown">
                                                    {data.deals.map((d, i) => (
                                                        <div key={i} className="deal-breakdown-item">
                                                            <span>{d.name} ({d.type})</span>
                                                            <span>{formatCurrency(d.amount)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<CommissionTracker />, document.getElementById('root'));
    </script>
</body>
</html>
